#!/usr/bin/env bash

#-----------------------------------------------------------Check some errors

ERR(){
	printf '%s\n' "doasedit: $2" 1>&2
	(($1 > 0)) && exit $1
}

((UID == 0)) && ERR 2 'denied to run as root...'

[[ -z "$1" || -n "$2" ]] && ERR 2 "doesn't specify file..."

[[ -f "$1" ]] || ERR 2 "$1 is a directory or doesn't exists..."

[[ -O "$1" || -w "$1" ]] && ERR 2 "$1 doesn't need root access..."

if [[ -r "$1" ]]; then
	Readable=1
else
	while read; do
		printf '%s\n' "$REPLY"
	done <<-EOF

		doasedit() doesn't has permission to read $1
		if continue you will need to type your password 3 times
		unless you have \`persist\` option in your /etc/doas.conf

	EOF

	read -p 'Do you want to continue? [y/N]: '
	case "$REPLY" in
		[Nn][Oo]|[Nn]|'')
			exit 1 ;;

		[Yy][Ee][Ss]|[Yy])
			Readable=0 ;;

		*)
			ERR 2 "unknown answer(s) $1..." ;;
	esac
fi

#-----------------------------------------------------------Prepare and Set variables

# Make random variables static
TMPFILE="${TMPDIR:-/tmp}/doasedit-$SRANDOM"

# Copy Original File to Tmp Directory
((Readable == 1)) && cp $1 $TMPFILE ||
	{ while :; do doas cp $1 $TMPFILE && break; done
	while :; do doas chown $USER $TMPFILE && break; done ;}

# Remove tmp file when exit
trap 'rm -f $TMPFILE' EXIT

[[ -w "$TMPFILE" ]] || ERR 2 "$1 is write protected, aborted..."

#----------------------------------------------------------Start to edit the file

# Edit tmp file
${DOAS_EDITOR:-vi} $TMPFILE ||
	ERR 2 '$DOAS_EDITOR is set to something that unusable...'

# Don't do anything if file's content doesn't change
cmp -s $1 $TMPFILE && ERR 1 "$1 doesn't change..."

while :; do
	# Break while loop only when user successfully type password
	doas cp $TMPFILE $1 && break
done
